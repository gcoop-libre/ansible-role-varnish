---
- name: Copy Varnish default VCL.
  template:
    src: "{{ varnish_default_vcl_template_path }}"
    dest: "{{ varnish_config_path }}/default.vcl"
    owner: root
    group: root
    mode: 0644
  notify: restart varnish

# https://github.com/geerlingguy/ansible-role-varnish/pull/28
- name: Correct varnish.service permissions
  file:
    path: "{{ varnish_systemd_config_path }}/varnish.service"
    owner: root
    group: root
    mode: 0644
  when: >
    (ansible_os_family == 'Debian') and
    (ansible_distribution_release == "jessie" or ansible_distribution_release == "xenial")

# https://github.com/geerlingguy/ansible-role-varnish/pull/33
- name: Ensure Varnish services start on boot.
  service:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - varnish
    - varnishncsa
    - varnishlog
  when: ansible_distribution_release not in ["xenial", "jessie"]
# Workaround for systems where sysv and systemd script files
# https://github.com/ansible/ansible-modules-core/issues/3764
- name: Ensure Varnish services start on boot.
  command: systemctl enable -f {{ item }}
  with_items:
    - varnish
    - varnishncsa
    - varnishlog
  when: ansible_distribution_release == "jessie"

# https://github.com/geerlingguy/ansible-role-varnish/pull/35
- name: Copy Debian Jessie/Xenial specific Varnish configs (systemd).
  template:
    src: varnish.service.j2
    dest: "{{ varnish_systemd_config_path }}/varnish.service"
    owner: root
    group: root
    mode: 0644
  when: >
    (ansible_os_family == 'Debian') and
    (ansible_distribution_release == "jessie" or ansible_distribution_release == "xenial")
  notify:
    - reload systemd
    - restart varnish
